<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner Panitia Master</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 480px; border-radius: 20px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .input-box { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        #reader { width: 100%; border-radius: 15px; overflow: hidden; background: #000; border: 3px solid #e2e8f0; }
        .setting-btn { background: none; border: none; color: #64748b; cursor: pointer; font-size: 0.8rem; text-decoration: underline; margin-top: 10px; }
        .info-panel { background: #eff6ff; padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center">QR Scanner Master</h2>
    
    <div id="setupView">
        <label>Nama Panitia:</label>
        <input type="text" id="panitiaName" class="input-box" placeholder="Contoh: Budi">
        
        <div id="urlSection" style="display:none; margin-top: 10px;">
            <label>Web App URL (Google Script):</label>
            <input type="text" id="webAppUrl" class="input-box" placeholder="https://script.google.com/macros/s/.../exec">
        </div>
        
        <button class="btn" onclick="startApp()">MULAI SCAN</button>
        <center><button class="setting-btn" onclick="toggleUrl()">Konfigurasi URL Web App</button></center>
    </div>

    <div id="scanView" style="display:none">
        <div class="info-panel">
            <b>Panitia:</b> <span id="namaP"></span><br>
            <small id="urlP" style="font-size: 0.7rem; color: #64748b;"></small>
        </div>
        <div id="reader"></div>
        <input type="text" id="usbInput" class="input-box" style="margin-top:15px; opacity:0.6" placeholder="Klik di sini jika pakai USB Scanner">
        <button class="btn" style="background:#64748b; margin-top:10px" onclick="location.reload()">GANTI PANITIA / URL</button>
    </div>
</div>

<script>
    let isProcessing = false;
    let html5QrCode;

    // Load URL dari memori browser (LocalStorage)
    window.onload = () => {
        const savedUrl = localStorage.getItem("webAppUrl");
        if (savedUrl) document.getElementById('webAppUrl').value = savedUrl;
    };

    function toggleUrl() {
        const x = document.getElementById('urlSection');
        x.style.display = (x.style.display === 'none') ? 'block' : 'none';
    }

    // Fungsi Suara (Audio API)
    function playSound(type) {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        if (type === 'success') {
            osc.frequency.setValueAtTime(880, audioCtx.currentTime); // Beep
            osc.type = 'sine';
        } else {
            osc.frequency.setValueAtTime(150, audioCtx.currentTime); // Buzz
            osc.type = 'sawtooth';
        }
        
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.3);
    }

    function startApp() {
        const panitia = document.getElementById('panitiaName').value;
        const url = document.getElementById('webAppUrl').value;

        if (!panitia || !url) return Swal.fire('Error', 'Nama Panitia dan URL Web App wajib diisi!', 'error');
        
        // Simpan URL agar tidak perlu isi lagi nanti
        localStorage.setItem("webAppUrl", url);
        localStorage.setItem("panitiaActive", panitia);

        document.getElementById('setupView').style.display = 'none';
        document.getElementById('scanView').style.display = 'block';
        document.getElementById('namaP').innerText = panitia;
        document.getElementById('urlP').innerText = url.substring(0, 40) + "...";
        
        initScanner();
    }

    function initScanner() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, onScanSuccess)
        .catch(err => Swal.fire('Kamera Error', 'Izin kamera ditolak!', 'error'));
    }

    // Input USB Scanner
    document.getElementById('usbInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') { onScanSuccess(e.target.value); e.target.value = ''; }
    });

    function onScanSuccess(decodedText) {
        if (isProcessing) return;
        isProcessing = true;

        const url = localStorage.getItem("webAppUrl");
        const panitia = localStorage.getItem("panitiaActive");

        Swal.fire({ title: 'Memverifikasi...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        // Kirim data ke Google Sheets melalui URL yang diinput
        fetch(url + "?qr=" + encodeURIComponent(decodedText) + "&p=" + encodeURIComponent(panitia))
        .then(response => response.json())
        .then(res => {
            if (res.status === "success") {
                playSound('success');
                Swal.fire({ icon: 'success', title: 'BERHASIL', text: res.msg, timer: 3000 });
            } else {
                playSound('error');
                Swal.fire({ icon: res.status === 'warning' ? 'warning' : 'error', title: 'GAGAL', text: res.msg });
            }
            setTimeout(() => { isProcessing = false; }, 3500);
        })
        .catch(err => {
            playSound('error');
            Swal.fire('Error', 'Gagal menyambung ke Web App. Cek URL Anda!', 'error');
            isProcessing = false;
        });
    }
</script>
</body>
</html>